<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChroniCARE - Book Appointment</title>

    <!-- Link to your ORIGINAL appointment-calendar.css -->
    <link rel="stylesheet" href="appointment-calendar.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>

<body>

    <!-- Optional Header -->
    <!-- <header class="page-header"> ... </header> -->

    <main>
        <div class="container">
            <div class="header">
                <span>Doctor Name</span> <!-- Placeholder, updated by JS -->
                <span>Book a session</span>
            </div>

            <div class="calendar-container">
                <div class="calendar-header">
                    <button id="prevMonthBtn" aria-label="Previous Month"><</button>
                    <h3 id="currentMonthYear">Month Year</h3>
                    <button id="nextMonthBtn" aria-label="Next Month">></button>
                </div>
                <div class="calendar" id="calendar">
                    <!-- Calendar days generated by JS -->
                     <p>Loading calendar...</p> <!-- Initial message -->
                </div>
            </div>

            <div class="time-slots-container">
                <h4>Available Time Slots:</h4>
                <div id="timeSlots">
                    <!-- Time slots generated by JS -->
                    <p>Select a date to view available time slots.</p>
                </div>
                 <!-- RENAMED Container and Button ID -->
                 <div id="requestAppointmentContainer" style="display: none; text-align: center; margin-top: 20px;">
                    <button id="requestAppointmentBtn" class="proceed-button"> <!-- Kept class for styling -->
                        <i class="fas fa-calendar-check"></i> <!-- Optional: Calendar Check Icon --> Request Appointment
                    </button>
                </div>
            </div>
        </div>

        <button class="back-button" id="backButton">Back</button>
    </main>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="index.html" class="nav-item">
            <i class="fa-solid fa-house"></i>
            <span>Home</span>
        </a>
        <a href="health-monitor.html" class="nav-item">
           <i class="fa-solid fa-medkit"></i>
            <span>Health Monitor</span>
        </a>
        <a href="telemedicine.html" class="nav-item active">
            <i class="fa-solid fa-video"></i>
            <span>Telemedicine</span>
        </a>
        <a href="profile.html" class="nav-item">
            <i class="fa-solid fa-user"></i>
            <span>Profile</span>
        </a>
    </nav>

    <script>
    // appointment-calendar.js (Complete Script for Phase 1 + Renaming)

    // --- Helper Functions ---
    function getQueryParam(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
    }

    // Helper function (can be shared or defined locally)
    function getPatientAuthToken() {
                    return localStorage.getItem('accessToken');
                }

    // Convert HH:MM (24hr) to h:mm AM/PM for display
    function convertTo12Hour(time24) {
        if (!time24 || !time24.includes(':')) return "Invalid Time";
        try {
            const [hours, minutes] = time24.split(':');
            let hoursInt = parseInt(hours);
            const ampm = hoursInt >= 12 ? 'PM' : 'AM';
            hoursInt = hoursInt % 12;
            hoursInt = hoursInt || 12; // Handle midnight
            return `${hoursInt}:${minutes} ${ampm}`;
        } catch (e) {
            console.error("Error converting time:", time24, e);
            return "Invalid Time";
        }
    }

    // Format Date object to YYYY-MM-DD string (TimeZone Safe)
    function formatDateISO(date) {
        if (!date || !(date instanceof Date)) {
             console.error("Invalid date passed to formatDateISO:", date);
             return '';
        }
        try {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        } catch (e) {
             console.error("Error formatting date components:", date, e);
             return '';
        }
    }
    // --- End Helper Functions ---


    document.addEventListener('DOMContentLoaded', function() {
        console.log("Appointment Calendar JS Loaded"); // DEBUG

        // --- Get Initial Info & DOM Elements ---
        const doctorName = getQueryParam('doctor_name');
        const doctorId = getQueryParam('doctor_id');

        const headerSpan = document.querySelector('.container .header span:first-child');
        const timeSlotsDiv = document.getElementById('timeSlots');
        // Use RENAMED variables/IDs
        const requestAppointmentContainer = document.getElementById('requestAppointmentContainer');
        const requestAppointmentBtn = document.getElementById('requestAppointmentBtn');
        const calendarDiv = document.getElementById('calendar');
        const currentMonthYearH3 = document.getElementById('currentMonthYear');
        const prevMonthBtn = document.getElementById('prevMonthBtn');
        const nextMonthBtn = document.getElementById('nextMonthBtn');
        const backButton = document.getElementById('backButton');

        // --- State ---
        const monthNames = ["January", "February", "March", "April", "May", "June",
            "July", "August", "September", "October", "November", "December"
        ];
        let currentCalendarDate = new Date();
        let selectedDateISO = null; // Store selected date as YYYY-MM-DD string
        let selectedTime24hr = null; // Store selected time as HH:MM (24hr) string
        const API_BASE_URL = 'https://chronicare.onrender.com'; // Base URL for API calls

        // --- Initial Setup ---
        if (headerSpan) { // Check if element exists
            if (doctorName) {
                headerSpan.textContent = `Dr. ${decodeURIComponent(doctorName)}`;
            } else {
                headerSpan.textContent = `Doctor Schedule`;
            }
        }
         if (!doctorId) {
            console.error("Doctor ID missing from URL!");
            if(timeSlotsDiv) timeSlotsDiv.innerHTML = "<p style='color: red;'>Error: Could not identify the doctor. Please go back and select a doctor.</p>";
            // Disable interactions if no doctor ID
             if(calendarDiv) calendarDiv.style.pointerEvents = 'none';
             if(prevMonthBtn) prevMonthBtn.disabled = true;
             if(nextMonthBtn) nextMonthBtn.disabled = true;
            return; // Stop script execution
        }


        // --- Calendar Generation ---
        function generateCalendar(year, month) {
            console.log(`Generating calendar for ${year}-${month + 1}`);
             if (!calendarDiv || !currentMonthYearH3) {
                 console.error("Calendar DOM elements not found for generation.");
                 return;
            }

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDay = firstDay.getDay(); // 0=Sun

            let calendarHTML = `<div class="day-name">S</div><div class="day-name">M</div><div class="day-name">T</div><div class="day-name">W</div><div class="day-name">T</div><div class="day-name">F</div><div class="day-name">S</div>`;

            for (let i = 0; i < startingDay; i++) {
                calendarHTML += '<div class="day empty"></div>';
            }

            const today = new Date();
            today.setHours(0,0,0,0);

            for (let day = 1; day <= daysInMonth; day++) {
                const dateObj = new Date(year, month, day);
                const dateStr = formatDateISO(dateObj);
                if (!dateStr) continue; // Skip if date formatting failed

                let dayClass = "day";
                let isDisabled = false;

                if (dateObj < today) { // Disable past dates
                    dayClass += " disabled";
                    isDisabled = true;
                }
                if (dateStr === selectedDateISO) { // Highlight selected date
                     dayClass += " selected";
                }
                calendarHTML += `<div class="${dayClass}" data-date="${dateStr}" ${isDisabled ? 'aria-disabled="true" tabindex="-1"' : 'tabindex="0"'} role="button">${day}</div>`; // Add accessibility attributes
            }

            calendarDiv.innerHTML = calendarHTML;
            currentMonthYearH3.textContent = `${monthNames[month]} ${year}`;
            addDayClickListeners();
            console.log("Calendar HTML generated and listeners added."); // DEBUG
        }

        function addDayClickListeners() {
            // Remove previous listeners to avoid duplicates if re-generating
            calendarDiv.querySelectorAll('.day:not(.empty):not(.disabled)').forEach(el => {
                el.replaceWith(el.cloneNode(true)); // Simple way to remove listeners
            });

            // Add new listeners
            calendarDiv.querySelectorAll('.day:not(.empty):not(.disabled)').forEach(dayElement => {
                dayElement.addEventListener('click', handleDayClick);
                 // Add keyboard accessibility (Enter key)
                 dayElement.addEventListener('keydown', (event) => {
                     if (event.key === 'Enter' || event.key === ' ') {
                         event.preventDefault(); // Prevent space bar scrolling
                         handleDayClick.call(dayElement, event); // Call handler with correct 'this' context
                     }
                 });
            });
            console.log("Day click listeners added."); // DEBUG
        }

        function handleDayClick(event) { // Combined handler for click/keydown
             const newlySelectedDateISO = this.dataset.date;
             console.log("Date selected:", newlySelectedDateISO); // DEBUG

             // Prevent re-fetching if same date is clicked again
             if (newlySelectedDateISO === selectedDateISO) {
                 console.log("Same date clicked, no action."); // DEBUG
                 return;
             }

             const previouslySelected = calendarDiv.querySelector('.day.selected');
             if (previouslySelected) previouslySelected.classList.remove('selected');

             this.classList.add('selected');
             selectedDateISO = newlySelectedDateISO;

             // Reset time selection
             selectedTime24hr = null;
             if(requestAppointmentContainer) requestAppointmentContainer.style.display = 'none';
             if(timeSlotsDiv) timeSlotsDiv.innerHTML = '<p>Loading available slots...</p>';

             displayTimeSlots(selectedDateISO);
         }


        // --- Time Slot Fetching and Display ---
        async function displayTimeSlots(dateISO) {
            if (!doctorId || !timeSlotsDiv) return;
            console.log(`Fetching slots for Dr. ${doctorId} on ${dateISO}`);

            const apiUrl = `${API_BASE_URL}appointments/doctors/${doctorId}/schedule?date=${dateISO}`;

            try {
                const response = await fetch(apiUrl);
                console.log(`GET ${apiUrl} status: ${response.status}`);

                if (!response.ok) {
                    if (response.status === 404) {
                         timeSlotsDiv.innerHTML = `<p>Doctor's schedule not set for this date.</p>`;
                         if(requestAppointmentContainer) requestAppointmentContainer.style.display = 'none';
                         return;
                    }
                    const errorData = await response.json().catch(()=>null);
                    throw new Error(errorData?.detail || `HTTP error ${response.status}`);
                }

                const timeSlotsData = await response.json();
                console.log("Received slots data:", timeSlotsData);

                if (!Array.isArray(timeSlotsData) || timeSlotsData.length === 0) {
                    timeSlotsDiv.innerHTML = `<p>No available appointment slots for this date.</p>`;
                     if(requestAppointmentContainer) requestAppointmentContainer.style.display = 'none';
                } else {
                    timeSlotsData.sort((a, b) => a.start_time.localeCompare(b.start_time));
                    let timeSlotsHTML = '';
                    timeSlotsData.forEach(slot => {
                        // Note: Your backend TimeSlotResponse only has start_time currently
                         timeSlotsHTML += `<div class="time-slot" data-time="${slot.start_time}" role="button" tabindex="0">${convertTo12Hour(slot.start_time)}</div>`; // Add accessibility
                    });
                    timeSlotsDiv.innerHTML = timeSlotsHTML;
                    addSlotClickListeners();
                     if(requestAppointmentContainer) requestAppointmentContainer.style.display = 'none'; // Hide button until selection
                }

            } catch (error) {
                console.error(`Error fetching/displaying time slots for ${dateISO}:`, error);
                timeSlotsDiv.innerHTML = `<p style='color: red;'>Error loading slots: ${error.message}.</p>`;
                 if(requestAppointmentContainer) requestAppointmentContainer.style.display = 'none';
            }
        }

        function addSlotClickListeners() {
             // Remove previous listeners
             timeSlotsDiv.querySelectorAll('.time-slot').forEach(el => {
                 el.replaceWith(el.cloneNode(true));
             });
             // Add new listeners
             timeSlotsDiv.querySelectorAll('.time-slot').forEach(slotElement => {
                 slotElement.addEventListener('click', handleSlotClick);
                 slotElement.addEventListener('keydown', (event) => {
                     if (event.key === 'Enter' || event.key === ' ') {
                          event.preventDefault();
                          handleSlotClick.call(slotElement, event);
                     }
                 });
            });
            console.log("Slot click listeners added."); // DEBUG
        }

         function handleSlotClick(event) { // Combined handler for click/keydown
             timeSlotsDiv.querySelectorAll('.time-slot.selected').forEach(ts => ts.classList.remove('selected'));
             this.classList.add('selected');
             selectedTime24hr = this.dataset.time; // Store HH:MM (24hr)
             console.log(`Time selected: ${selectedTime24hr} (${convertTo12Hour(selectedTime24hr)})`);
             if(requestAppointmentContainer) requestAppointmentContainer.style.display = 'block'; // Show button
         }


        // --- Event Listeners Setup ---
        if(prevMonthBtn) prevMonthBtn.addEventListener('click', () => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            selectedDateISO = null;
            selectedTime24hr = null;
            generateCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
            if(timeSlotsDiv) timeSlotsDiv.innerHTML = "<p>Select a date to view available time slots.</p>";
            if(requestAppointmentContainer) requestAppointmentContainer.style.display = 'none';
        });

        if(nextMonthBtn) nextMonthBtn.addEventListener('click', () => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
             selectedDateISO = null;
             selectedTime24hr = null;
            generateCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
            if(timeSlotsDiv) timeSlotsDiv.innerHTML = "<p>Select a date to view available time slots.</p>";
             if(requestAppointmentContainer) requestAppointmentContainer.style.display = 'none';
        });

        // --- Booking Request ---
         if(requestAppointmentBtn) requestAppointmentBtn.addEventListener('click', () => {
            if (selectedDateISO && selectedTime24hr) {
                const doctorNameToConfirm = doctorName ? decodeURIComponent(doctorName) : "the selected doctor";
                const timeToConfirm = convertTo12Hour(selectedTime24hr);

                // Use confirm for simplicity, consider modal for better UX later
                if (confirm(`Request appointment with Dr. ${doctorNameToConfirm} on ${selectedDateISO} at ${timeToConfirm}?`)) {

                    const appointmentData = {
                        doctor_id: parseInt(doctorId),
                        date: selectedDateISO,
                        time: selectedTime24hr
                    };

                    const bookAppointmentUrl = `${API_BASE_URL}/appointments/book`; // Use base URL
                    const patientToken = getPatientAuthToken(); // Get the token

                    console.log("Sending booking request:", appointmentData);
                    console.log("Using token:", patientToken ? "Yes" : "No"); // DEBUG

                    if (!patientToken) {
                     alert("Authentication Error: You seem to be logged out. Please log in again.");
                     requestAppointmentBtn.disabled = false; // Re-enable button
                     requestAppointmentBtn.innerHTML = '<i class="fas fa-calendar-check"></i> Request Appointment';
                     return; // Stop if no token
                }

                     // Disable button while processing
                     requestAppointmentBtn.disabled = true;
                     requestAppointmentBtn.textContent = 'Requesting...';


                    fetch(bookAppointmentUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json',
                                   'Authorization': `Bearer ${patientToken}`
                         },
                        body: JSON.stringify(appointmentData)
                        // Add Authorization header here if patient needs to be logged in
                    })
                    .then(async response => {
                        const responseData = await response.json().catch(() => ({})); // Attempt to parse JSON, default to empty object on failure
                         console.log(`POST /book response status: ${response.status}`);
                        if (!response.ok) {
                            console.error("Booking failed response:", responseData);
                            // Use detail from backend response if available
                            throw new Error(responseData.detail || `Request failed (${response.status})`);
                        }
                        return responseData;
                    })
                    .then(data => {
                         console.log("Booking successful response:", data);
                        alert(data.message || 'Appointment requested successfully!');
                        // Reset selection and refresh slots
                        selectedTime24hr = null;
                         if(timeSlotsDiv) timeSlotsDiv.querySelectorAll('.time-slot.selected').forEach(ts => ts.classList.remove('selected'));
                         if(requestAppointmentContainer) requestAppointmentContainer.style.display = 'none';
                        displayTimeSlots(selectedDateISO); // Refresh slots for the day
                    })
                    .catch(error => {
                        console.error('Error booking appointment:', error);
                        alert(`Failed to request appointment: ${error.message}. Please check availability or try again.`);
                         // Reset selection state on error? Optional.
                        // selectedTime24hr = null;
                        // if(timeSlotsDiv) timeSlotsDiv.querySelectorAll('.time-slot.selected').forEach(ts => ts.classList.remove('selected'));
                        // if(requestAppointmentContainer) requestAppointmentContainer.style.display = 'none';
                    })
                    .finally(() => {
                         // Re-enable button and reset text regardless of outcome
                         requestAppointmentBtn.disabled = false;
                         requestAppointmentBtn.innerHTML = '<i class="fas fa-calendar-check"></i> Request Appointment'; // Restore original text/icon
                    });
                }
            } else {
                alert("Please select both a date and a time slot.");
            }
        });

        // --- Back Button ---
        function goBack() {
            // TODO: Adjust this URL based on how user gets here
            // Maybe history.back() is better if the previous page is always correct?
            // window.history.back();
            window.location.href = `telemedicine.html`; // Or specific previous page
        }
        if(backButton) backButton.addEventListener('click', goBack);

        // --- Initial Calendar Load ---
        generateCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
        console.log("Initial calendar generated on load.");

    }); // End DOMContentLoaded
    </script>

</body>
</html>